# Next.js KOSPI Dashboard - ë©€í‹°ìŠ¤í…Œì´ì§€ Docker ë¹Œë“œ
# 
# ğŸ¯ ì „ëµ: ë¹Œë“œìš© ì´ë¯¸ì§€ + ëŸ°íƒ€ì„ìš© ì´ë¯¸ì§€ ë¶„ë¦¬
# ğŸ“¦ ê²°ê³¼: ìš©ëŸ‰ ìµœì í™” (1GB â†’ 200MB)

# =============================================
# ğŸ“¦ Stage 1: Dependencies (ì˜ì¡´ì„± ì„¤ì¹˜)
# =============================================
FROM node:18-alpine AS deps
# ğŸ’¡ Alpine Linux: ê°€ì¥ ê°€ë²¼ìš´ Node.js ì´ë¯¸ì§€ (5MB vs 200MB)

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL stage=deps
LABEL description="Node.js dependencies installation stage"

# ğŸ”§ Alpine Linux íŒ¨í‚¤ì§€ ê´€ë¦¬ìë¡œ ê¸°ë³¸ ë„êµ¬ ì„¤ì¹˜
# ğŸ’¡ ìµœì‹  Alpineì—ì„œëŠ” ê¸°ë³¸ íŒ¨í‚¤ì§€ë¡œ ì¶©ë¶„í•¨
RUN apk update && apk add --no-cache dumb-init

# ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ“‹ package.jsonê³¼ lock íŒŒì¼ë§Œ ë¨¼ì € ë³µì‚¬ (Docker ë ˆì´ì–´ ìºì‹±!)
COPY package.json pnpm-lock.yaml* package-lock.json* yarn.lock* ./
# ğŸ’¡ ìºì‹± ì „ëµ: ì˜ì¡´ì„±ì´ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©´ ì´ ë ˆì´ì–´ ì¬ì‚¬ìš©

# ğŸ› ï¸ ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ + ê°œë°œ)
RUN \
  if [ -f pnpm-lock.yaml ]; then \
    npm install -g pnpm && pnpm install --frozen-lockfile; \
  elif [ -f package-lock.json ]; then \
    npm ci; \
  elif [ -f yarn.lock ]; then \
    yarn install --frozen-lockfile; \
  else \
    npm install; \
  fi

# =============================================
# ğŸ—ï¸ Stage 2: Builder (ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ)
# =============================================
FROM node:18-alpine AS builder

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL stage=builder
LABEL description="Next.js application build stage"

# ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ“¦ ì´ì „ ìŠ¤í…Œì´ì§€ì—ì„œ node_modules ë³µì‚¬
COPY --from=deps /app/node_modules ./node_modules
# ğŸ’¡ ë©€í‹°ìŠ¤í…Œì´ì§€ í•µì‹¬: ì´ì „ ìŠ¤í…Œì´ì§€ì˜ ê²°ê³¼ë¬¼ í™œìš©

# ğŸ“ ì†ŒìŠ¤ ì½”ë“œ ì „ì²´ ë³µì‚¬
COPY . .

# ğŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ë¹Œë“œíƒ€ì„)
# ğŸ’¡ Next.js íŠ¹ì§•: í™˜ê²½ë³€ìˆ˜ê°€ ë¹Œë“œì— í¬í•¨ë¨
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production

# ğŸ—ï¸ Next.js ë¹Œë“œ ì‹¤í–‰
RUN \
  if [ -f pnpm-lock.yaml ]; then \
    npm install -g pnpm && pnpm build; \
  elif [ -f package-lock.json ]; then \
    npm run build; \
  elif [ -f yarn.lock ]; then \
    yarn build; \
  else \
    npm run build; \
  fi

# =============================================
# ğŸš€ Stage 3: Runner (í”„ë¡œë•ì…˜ ì‹¤í–‰)
# =============================================
FROM node:18-alpine AS runner

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL stage=runner
LABEL description="Next.js production runtime"
LABEL maintainer="kospi-project"

# ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ”§ í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# ğŸ‘¤ ë³´ì•ˆ: ë¹„ë£¨íŠ¸ ì‚¬ìš©ì ìƒì„±
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
# ğŸ’¡ ë³´ì•ˆ ëª¨ë²”ì‚¬ë¡€: ì»¨í…Œì´ë„ˆë¥¼ ë£¨íŠ¸ë¡œ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ

# ğŸ“¦ í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/node_modules ./node_modules

# ğŸ“ ë¹Œë“œëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³µì‚¬
COPY --from=builder --chown=nextjs:nodejs /app/.next ./.next
# ğŸ’¡ chown: íŒŒì¼ ì†Œìœ ê¶Œì„ nextjs ì‚¬ìš©ìì—ê²Œ í• ë‹¹

# ğŸ“ ì •ì  íŒŒì¼ ë³µì‚¬ (public í´ë”)
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# ğŸ‘¤ ì‚¬ìš©ì ì „í™˜
USER nextjs

# ğŸŒ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 3000
ENV PORT=3000

# ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
CMD ["npm", "start"] 