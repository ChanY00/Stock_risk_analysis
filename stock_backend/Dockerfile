# Django KOSPI ë°±ì—”ë“œë¥¼ ìœ„í•œ Dockerfile
# ğŸ Python 3.11 ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì‚¬ìš©
FROM python:3.11-slim as base

# ğŸ“ ë©”íƒ€ë°ì´í„°
LABEL maintainer="kospi-project"
LABEL description="KOSPI Django Backend with WebSocket support"

# ğŸ”§ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ì—…ë°ì´íŠ¸
RUN apt-get update && apt-get install -y \
    postgresql-client \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ‘¤ ë¹„ë£¨íŠ¸ ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ ê°•í™”)
RUN groupadd -r django && useradd -r -g django django

# ğŸ“‹ requirements.txt ë¨¼ì € ë³µì‚¬ (ìºì‹± ìµœì í™”)
COPY requirements.txt .

# ğŸ› ï¸ Python ì˜ì¡´ì„± ì„¤ì¹˜
RUN pip install --no-cache-dir -r requirements.txt

# ğŸ“ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ğŸ“ ì •ì  íŒŒì¼ ë° ë¯¸ë””ì–´ ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /app/staticfiles /app/media

# ğŸ“œ ì—”íŠ¸ë¦¬í¬ì¸íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ (USER ì „í™˜ ì „ì— ì‹¤í–‰)
RUN chmod +x /app/docker-entrypoint.sh

# ğŸ” ê¶Œí•œ ì„¤ì •
RUN chown -R django:django /app
USER django

# ğŸŒ í¬íŠ¸ ë…¸ì¶œ (Django: 8000)
EXPOSE 8000

# ğŸš€ ê°œë°œ í™˜ê²½ (ê¸°ë³¸)
FROM base as development
ENV DJANGO_SETTINGS_MODULE=stock_backend.settings
CMD ["./docker-entrypoint.sh", "development"]

# ğŸ­ í”„ë¡œë•ì…˜ í™˜ê²½
FROM base as production
ENV DJANGO_SETTINGS_MODULE=stock_backend.settings
ENV DEBUG=False
CMD ["./docker-entrypoint.sh", "production"] 